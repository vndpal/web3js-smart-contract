<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voting Application</title>
    <style>
      /* CSS styles */
    </style>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.0/dist/web3.min.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>Voting Application</h1>
      <button id="loadCandidatesButton">Load Candidates</button>
      <div id="candidatesContainer">
        <select id="candidatesSelect">
          <option value="" disabled selected>Select a candidate</option>
        </select>
        <button id="voteButton">Vote</button>
      </div>
      <div class="result" id="result"></div>
    </div>

    <script>
      // Initialize Web3
      const web3 = new Web3("http://127.0.0.1:8545/");

      // Function to load ABI and contract address
      async function loadContractData() {
        try {
          // Fetch ABI from JSON file
          const abiResponse = await fetch("./MyVotingContractAbi.json");
          const abi = await abiResponse.json();

          // Fetch contract address from text file
          const addressResponse = await fetch("./MyVotingContractAddress.txt");
          const address = await addressResponse.text();

          // Ensure address is trimmed
          const trimmedAddress = address.trim();

          return { abi, address: trimmedAddress };
        } catch (error) {
          console.error("Error loading contract data:", error);
          throw error;
        }
      }

      // Function to load candidates
      async function loadCandidates() {
        try {
          const { abi, address } = await loadContractData();
          const contract = new web3.eth.Contract(abi, address);

          // Get the list of candidates
          const candidates = await contract.methods.getCandidates().call();

          // Populate the candidates dropdown
          const selectElement = document.getElementById("candidatesSelect");
          selectElement.innerHTML =
            '<option value="" disabled selected>Select a candidate</option>';
          candidates.forEach((candidate) => {
            const option = document.createElement("option");
            option.value = candidate;
            option.textContent = candidate;
            selectElement.appendChild(option);
          });

          // Fetch and display votes for all candidates
          const votesList = await Promise.all(
            candidates.map((candidate) =>
              contract.methods
                .totalVotesFor(candidate)
                .call()
                .then((votes) => ({ candidate, votes }))
            )
          );

          let resultText = "Candidates and their votes:\n";
          votesList.forEach(({ candidate, votes }) => {
            resultText += `${candidate}: ${votes} votes\n`;
          });
          document.getElementById("result").innerText = resultText;
        } catch (error) {
          console.error(error);
          document.getElementById(
            "result"
          ).innerText = `Error: ${error.message}`;
          document.getElementById("result").classList.add("error");
        }
      }

      // Function to vote for a candidate
      async function voteForCandidate() {
        try {
          const { abi, address } = await loadContractData();
          const contract = new web3.eth.Contract(abi, address);

          const accounts = await web3.eth.getAccounts();
          const defaultAccount = accounts[0];

          const candidate = document.getElementById("candidatesSelect").value;
          if (!candidate) {
            document.getElementById("result").innerText =
              "Please select a candidate.";
            return;
          }

          // Cast a vote for the selected candidate
          const receipt = await contract.methods
            .voteForCandidate(candidate)
            .send({
              from: defaultAccount,
              gas: 1000000,
              gasPrice: "10000000000",
            });
          console.log("Transaction Hash: " + receipt.transactionHash);

          // Update votes for all candidates
          await loadCandidates(); // Refresh the list of candidates and votes
        } catch (error) {
          console.error(error);
          document.getElementById(
            "result"
          ).innerText = `Error: ${error.message}`;
          document.getElementById("result").classList.add("error");
        }
      }

      // Add event listeners to buttons
      document
        .getElementById("loadCandidatesButton")
        .addEventListener("click", loadCandidates);
      document
        .getElementById("voteButton")
        .addEventListener("click", voteForCandidate);
    </script>
  </body>
</html>
